# ────────────────────────────────────────────────────────────────
# Cloud Build pipeline for the “quote-api” Cloud Run service
#   • PR trigger  → _TARGET_ENV=staging  → build only
#   • Push-main   → _TARGET_ENV=prod     → build + deploy (+ optional canary)
# ────────────────────────────────────────────────────────────────
steps:
# 1) Build & push image
- id: build-image
  name: gcr.io/cloud-builders/docker
  args:
    - build
    - '--tag=us-central1-docker.pkg.dev/$PROJECT_ID/quote-api/quote-api:${SHORT_SHA}'
    - '--tag=us-central1-docker.pkg.dev/$PROJECT_ID/quote-api/quote-api:latest'
    - .

# 2) Push both tags
- id: push-image
  name: gcr.io/cloud-builders/docker
  args:
    - push
    - 'us-central1-docker.pkg.dev/$PROJECT_ID/quote-api/quote-api:${SHORT_SHA}'
- id: push-latest
  name: gcr.io/cloud-builders/docker
  args:
    - push
    - 'us-central1-docker.pkg.dev/$PROJECT_ID/quote-api/quote-api:latest'




# 3) Deploy to Cloud Run (ONLY for prod)
- id: deploy-prod
  name: gcr.io/cloud-builders/gcloud
  entrypoint: bash
  args:
    - -c
    - |
      if [[ "$_TARGET_ENV" == "prod" ]]; then
        echo "🔄 Deploying to Cloud Run (prod)…"
        gcloud run deploy quote-api \
          --image=us-central1-docker.pkg.dev/$PROJECT_ID/quote-api/quote-api:latest \
          --revision-suffix=sha-${SHORT_SHA} \
          --region=us-central1 \
          --platform=managed \
          --allow-unauthenticated
      else
        echo "⚠️  Skipping deploy – _TARGET_ENV=$${_TARGET_ENV}"
      fi

# 3) Optional canary split (10 % to new rev) – ONLY for prod
- id: canary-split
  name: gcr.io/cloud-builders/gcloud
  entrypoint: bash
  args:
    - -c
    - |
      # Cloud Build substitutions (like $_TARGET_ENV, ${PROJECT_ID}) use single '$'
      if [[ "$_TARGET_ENV" == "prod" ]]; then
        echo "🔍 Fetching latest two revisions for canary split..."

        # For BASH internal variables and command substitution:
        # Use '$$' to ensure Cloud Build passes a literal '$' to bash.
        # Renamed REVISIONS to _cb_revision_list_output for uniqueness.
        _cb_revision_list_output=$$(gcloud run revisions list \
          --service=quote-api \
          --region=us-central1 \
          --platform=managed \
          --sort-by="~metadata.creationTimestamp" \
          --limit=2 \
          --format="value(metadata.name)" \
          --project=${PROJECT_ID}) # ${PROJECT_ID} is a Cloud Build substitution

        # Check if the command to get revisions failed or returned empty
        if [[ -z "$$_cb_revision_list_output" ]]; then
          echo "❌ ERROR: Failed to fetch revision list or list is empty. Skipping canary."
          exit 1
        fi

        # Convert multi-line output to a bash array _cb_rev_array
        mapfile -t _cb_rev_array <<< "$$_cb_revision_list_output"

        # Access array elements using bash syntax, escaping '$' with '$$' for Cloud Build
        _cb_new_revision="$${_cb_rev_array[0]}"
        _cb_previous_stable_revision="" # Default to empty

        if [[ $${#_cb_rev_array[@]} -gt 1 ]]; then
          _cb_previous_stable_revision="$${_cb_rev_array[1]}"
        fi

        # Validate that _cb_new_revision is not empty
        if [[ -z "$$_cb_new_revision" ]]; then
          echo "❌ ERROR: Could not determine new revision name from fetched list. Skipping canary."
          exit 1
        fi

        echo "🆕 New Revision: $$_cb_new_revision"
        if [[ -n "$$_cb_previous_stable_revision" ]]; then
          echo "🕰️ Previous Stable Revision: $$_cb_previous_stable_revision"
          echo "🪄 Applying 10% canary to $$_cb_new_revision, 90% to $$_cb_previous_stable_revision"
          gcloud run services update-traffic quote-api \
            --region=us-central1 \
            --platform=managed \
            --to-revisions="$$_cb_new_revision=10,$$_cb_previous_stable_revision=90" \
            --project=${PROJECT_ID} # Cloud Build substitution
        else
          # Only one revision exists (the new one), so it gets all traffic by default.
          echo "✅ Only one revision exists ($$_cb_new_revision). All traffic (100%) automatically goes to it. No canary split needed."
        fi
      else
        # $_TARGET_ENV is a Cloud Build substitution, so single '$' is correct
        echo "⚠️  Skipping canary – _TARGET_ENV=${_TARGET_ENV}"
      fi

- id: deploy- not, and you must use alpine/helm, proper auth is key.

  # The alpine/helm image likely DOEShelm
  name: 'gcr.io/cloud-builders/helm:v3.12.0' # Use a specific, stable version
  args:
    - 'upgrade'
    - '--install'
    - NOT have gcloud.
  # So this gcloud command will fail within the alpine/helm container.
  # 'quote-api'         # Your Helm release name
    - './charts/quote-api' # Path to your gcloud container clusters get-credentials quote-api-cluster \
  #  --zone us-central1- chart
    - '--namespace'
    - 'quote-api'
    - '--create-namespace' #a \
  #  --project=${PROJECT_ID}

  echo "Running helm upgrade..."
  # Helm Good to have
    - '--set'
    - 'image.tag=${SHORT_SHA}'
    - '--set'
    - 'image.repository=us-central1-docker.pkg.dev/$PROJECT_ID needs a KUBECONFIG or to be running where kubectl is configured.
  # Without the gcloud get-credentials above,/quote-api/quote-api'
    - '--atomic' # This is a good flag: waits for deployment to be this helm command will likely fail
  # to connect to your cluster.
  helm upgrade --install quote-api ./charts/quote-api \
    --namespace quote-api \
    --create-namespace \
    --set image. ready & rolls back on failure
    - '--timeout' # Example: wait up to 5 minutes
    -tag=${SHORT_SHA} \
    --set image.repository=us-central1-docker.pkg. '5m'
  # waitFor: ['YourPushStepID'] # Make sure images are pushed first
options:
  logging: CLOUD_LOGGING_ONLY

